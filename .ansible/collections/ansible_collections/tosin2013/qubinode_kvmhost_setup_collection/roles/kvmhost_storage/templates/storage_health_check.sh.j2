#!/bin/bash
# KVM Host Storage Health Check Script
# Generated by kvmhost_storage role

set -euo pipefail

echo "=== KVM Host Storage Health Check ==="
echo "Date: $(date)"
echo

# Storage Usage Summary
echo "Storage Usage Summary:"
echo "======================"
df -h | grep -E "(Filesystem|libvirt|mapper)" || echo "No specialized storage found"
echo

# LVM Status
{% if kvmhost_storage_lvm_enabled %}
echo "LVM Status:"
echo "==========="
if command -v vgdisplay >/dev/null 2>&1; then
    echo "Volume Groups:"
    vgs 2>/dev/null || echo "No volume groups found"
    echo
    echo "Logical Volumes:"
    lvs 2>/dev/null || echo "No logical volumes found"
    echo
else
    echo "LVM tools not available"
fi
{% endif %}

# Libvirt Storage Pools
echo "Libvirt Storage Pools:"
echo "======================"
if command -v virsh >/dev/null 2>&1; then
    virsh pool-list --all 2>/dev/null || echo "Unable to query libvirt pools"
else
    echo "virsh command not available"
fi
echo

# Filesystem Health
echo "Filesystem Health:"
echo "=================="
# Check for recent filesystem errors
echo "Recent filesystem errors (last 50 lines from dmesg):"
dmesg | grep -i "filesystem\|ext4\|xfs" | grep -i "error" | tail -10 || echo "No recent filesystem errors found"
echo

# Storage Performance Info
echo "Storage Performance Info:"
echo "========================="
echo "Block devices and I/O schedulers:"
for device in $(lsblk -dn -o NAME | grep -v loop); do
    if [[ -f "/sys/block/$device/queue/scheduler" ]]; then
        scheduler=$(cat "/sys/block/$device/queue/scheduler")
        echo "$device: $scheduler"
    fi
done
echo

# Summary
echo "=== Health Check Complete ==="
echo "For detailed monitoring, check: /var/log/kvmhost-storage.log"
