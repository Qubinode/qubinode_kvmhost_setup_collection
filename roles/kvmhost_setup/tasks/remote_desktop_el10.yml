# ============================================================
# RHEL 10 Remote Desktop Setup (RDP/Wayland)
# ============================================================
#
# Technology: gnome-remote-desktop (Wayland-native RDP)
# Supported: RHEL 10.x, CentOS Stream 10
#
# CRITICAL: This implementation requires SELinux policy fix for
# Red Hat Bugzilla 2271661 (gnome-remote-desktop incompatibility
# with enforcing mode).
#
# Security-First Design: This task will FAIL if the SELinux fix
# is not present, rather than compromise hypervisor security.
#
# Related: ADR-0015 - Remote Desktop Architecture Decision
# ============================================================

- name: Display RHEL 10 RDP setup information
  ansible.builtin.debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ðŸ” RHEL 10 Remote Desktop - Security-First Configuration
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Platform: {{ kvmhost_os_family }} {{ kvmhost_os_major_version }}
      Technology: gnome-remote-desktop (Wayland-native RDP)

      Security Check: Validating SELinux policy version...
      Required Fix: Red Hat BZ 2271661

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tags:
    - rhel10
    - security

# ============================================================
# STEP 1: SELinux Policy Version Check
# ============================================================

- name: Query selinux-policy package version
  ansible.builtin.command:
    cmd: rpm -q selinux-policy --queryformat '%{VERSION}-%{RELEASE}'
  register: selinux_policy_version_raw
  changed_when: false
  failed_when: false
  tags:
    - selinux
    - validation

- name: Set SELinux policy version fact
  ansible.builtin.set_fact:
    selinux_policy_version: "{{ selinux_policy_version_raw.stdout | default('unknown') }}"
  tags:
    - selinux

- name: Display detected SELinux policy version
  ansible.builtin.debug:
    msg: |
      SELinux Policy Information:
      - Installed Version: {{ selinux_policy_version }}
      - SELinux Status: {{ ansible_selinux.status | default('unknown') }}
      - SELinux Mode: {{ ansible_selinux.mode | default('unknown') }}
  tags:
    - selinux

# NOTE: The version comparison is currently set to a placeholder.
# When Red Hat ships the fix for BZ 2271661, update this version check
# to the exact selinux-policy version containing the fix.
#
# Example: When the fix ships in selinux-policy-40.25.0-1.el10,
# update the version check below to match that version.

- name: Check if SELinux policy contains BZ 2271661 fix
  ansible.builtin.set_fact:
    el10_rdp_selinux_fix_applied: >-
      {{
        selinux_policy_version is version('40.25.0', '>=') or
        (selinux_policy_version is version('999.0.0', '>='))
      }}
  tags:
    - selinux
    - validation

- name: Check if SELinux is in enforcing mode
  ansible.builtin.set_fact:
    selinux_is_enforcing: >-
      {{
        ansible_selinux is defined and
        ansible_selinux.status == 'enabled' and
        ansible_selinux.mode == 'enforcing'
      }}
  tags:
    - selinux

# ============================================================
# STEP 2: Security-First Validation
# ============================================================

- name: Display SELinux override warning (if forced)
  ansible.builtin.debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âš ï¸  SECURITY OVERRIDE ACTIVE
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      force_gnome_remote_desktop_el10: {{ force_gnome_remote_desktop_el10 }}

      You have chosen to bypass SELinux policy validation and install
      gnome-remote-desktop despite the BZ 2271661 SELinux incompatibility.

      Current System State:
      - SELinux Status: {{ ansible_selinux.status | default('unknown') }}
      - SELinux Mode: {{ ansible_selinux.mode | default('unknown') }}
      - SELinux Policy: {{ selinux_policy_version }}
      - BZ 2271661 Fix: NOT DETECTED

      âš ï¸  EXPECTED BEHAVIOR:
      - Installation will proceed
      - Services will start
      - RDP connections may FAIL due to SELinux denials
      - Check /var/log/audit/audit.log for AVC denials

      ðŸ”§ TROUBLESHOOTING:
      If RDP connections fail, you may need to:
      1. Set SELinux to permissive: sudo setenforce 0
      2. Monitor for denials: sudo ausearch -m avc -ts recent
      3. Generate custom policy (advanced)

      âš ï¸  NOT RECOMMENDED FOR PRODUCTION KVM HYPERVISORS

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when:
    - force_gnome_remote_desktop_el10 | default(false) | bool
    - not el10_rdp_selinux_fix_applied
    - selinux_is_enforcing
  tags:
    - security
    - warning

- name: Fail if RDP requested but SELinux fix not present (unless forced)
  ansible.builtin.fail:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ðŸ”’ SECURITY VALIDATION FAILED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Remote Desktop (gnome-remote-desktop) cannot be safely enabled
      on RHEL 10 at this time.

      ðŸ”´ ROOT CAUSE:
      Red Hat Bugzilla 2271661 documents an incompatibility between
      gnome-remote-desktop's "Remote Login" mode and SELinux when
      operating in enforcing mode.

      Current System State:
      - SELinux Status: {{ ansible_selinux.status | default('unknown') }}
      - SELinux Mode: {{ ansible_selinux.mode | default('unknown') }}
      - SELinux Policy: {{ selinux_policy_version }}
      - BZ 2271661 Fix: NOT DETECTED

      ðŸ” SECURITY-FIRST PRINCIPLE:
      This collection prioritizes KVM hypervisor security and will
      NOT disable SELinux as a workaround. SELinux provides sVirt
      (Secure Virtualization) mandatory access control, which is
      essential for isolating virtual machines from each other and
      from the host system.

      Disabling SELinux would create a catastrophic security failure
      for multi-tenant virtualization environments.

      âœ… RESOLUTION:
      The SELinux policy fix will be included in a future selinux-policy
      update. To enable remote desktop when the fix is available:

      1. Update the selinux-policy package:
         sudo dnf update selinux-policy

      2. Verify the updated version is installed:
         rpm -q selinux-policy

      3. Re-run this playbook. The SELinux check will pass automatically
         when the fixed policy version (>= 40.25.0) is detected.

      â­ï¸  WORKAROUNDS:

      Option 1 (Disable remote desktop):
         enable_remote_desktop: false

      Option 2 (Force installation - DEV/TEST ONLY):
         force_gnome_remote_desktop_el10: true

         âš ï¸  WARNING: This may result in non-functional RDP due to
         SELinux denials. Only use for development/testing!

      ðŸ“š REFERENCES:
      - Red Hat Bugzilla 2271661: gnome-remote-desktop SELinux issue
      - ADR-0015: Remote Desktop Architecture Decision
      - FINDINGS.md: Section 5.0 - SELinux Integration Failure

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when:
    - not el10_rdp_selinux_fix_applied
    - selinux_is_enforcing
    - not (force_gnome_remote_desktop_el10 | default(false) | bool)
  tags:
    - security
    - validation
    - adr_0015

- name: Display SELinux compatibility warning (permissive/disabled)
  ansible.builtin.debug:
    msg: |
      âš ï¸  WARNING: SELinux is not in enforcing mode

      Current Mode: {{ ansible_selinux.mode | default('unknown') }}

      gnome-remote-desktop setup will proceed, but for production
      KVM hypervisors, SELinux should be enabled in enforcing mode
      for proper sVirt isolation.

      When the SELinux policy fix (BZ 2271661) is available, please:
      1. Update selinux-policy package
      2. Set SELinux to enforcing mode
      3. Re-run this playbook
  when:
    - not selinux_is_enforcing
  tags:
    - security
    - warning

# ============================================================
# STEP 3: Proceed with gnome-remote-desktop Setup
# ============================================================

- name: Display proceeding with RDP setup message
  ansible.builtin.debug:
    msg: |
      âœ… SELinux Validation Passed

      {% if el10_rdp_selinux_fix_applied %}
      SELinux Policy Fix: DETECTED (version {{ selinux_policy_version }})
      Deployment Mode: PRODUCTION SAFE
      {% elif force_gnome_remote_desktop_el10 | default(false) | bool %}
      SELinux Policy Fix: NOT DETECTED
      Deployment Mode: FORCED OVERRIDE (âš ï¸  DEV/TEST ONLY)
      Override Flag: force_gnome_remote_desktop_el10 = true
      {% else %}
      SELinux Mode: {{ ansible_selinux.mode | default('not enforcing') }}
      Deployment Mode: PERMISSIVE/DISABLED
      {% endif %}

      Proceeding with gnome-remote-desktop configuration...
  when:
    - >
      el10_rdp_selinux_fix_applied or not selinux_is_enforcing or
      (force_gnome_remote_desktop_el10 | default(false) | bool)
  tags:
    - rdp

- name: Include gnome-remote-desktop setup tasks
  ansible.builtin.include_tasks: setup_gnome_remote_desktop.yml
  when:
    - >
      el10_rdp_selinux_fix_applied or not selinux_is_enforcing or
      (force_gnome_remote_desktop_el10 | default(false) | bool)
  tags:
    - rdp
    - gnome_remote_desktop
