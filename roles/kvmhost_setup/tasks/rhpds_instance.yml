# ============================================================
# Phase 1: RHEL 10 Remote Desktop Fail-Fast Protection
# Per ADR-0015: Remote Desktop Architecture Decision
# ============================================================

- name: Fail fast on RHEL 10 (Remote Desktop is not yet supported)
  ansible.builtin.fail:
    msg: |
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      âŒ FATAL: Remote Desktop (enable_vnc: true) is NOT supported on RHEL 10
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

      Platform: {{ kvmhost_os_family }} {{ kvmhost_os_full_version }}

      ðŸ”´ WHY THIS FAILED:
      RHEL 10 / CentOS Stream 10 deprecates the X.Org display server and removes
      VNC/X11-based remote access packages (tigervnc-server, xrdp).

      The new RDP-based architecture (gnome-remote-desktop) is currently BLOCKED
      by Red Hat Bugzilla 2271661: SELinux incompatibility in enforcing mode.

      ðŸ”’ SECURITY-FIRST PRINCIPLE:
      This collection prioritizes KVM hypervisor security and will NOT disable
      SELinux. SELinux provides sVirt isolation for virtual machines, which is
      essential for secure multi-tenant virtualization.

      ðŸ“‹ WORKAROUND:
      Set 'enable_vnc: false' in your inventory for RHEL 10 hosts.

      ðŸ“š REFERENCES:
      - ADR-0015: Remote Desktop Architecture Decision
      - Red Hat BZ 2271661: gnome-remote-desktop SELinux incompatibility
      - RHEL 10 will be supported when the SELinux policy is fixed upstream

      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  when:
    - enable_vnc | default(true) | bool
    - kvmhost_os_major_version | int >= 10
  tags:
    - remote_desktop
    - security
    - adr_0015

# ============================================================
# RHEL 8/9 Remote Desktop Setup (VNC/X11)
# ============================================================

- name: Install Server with GUI group
  ansible.builtin.dnf:
    name: "@Server with GUI"
    state: present
  become: true
  when:
    - enable_vnc | default(true) | bool

- name: Enable EPEL repository using DNF module (ADR-0001 compliant)
  ansible.builtin.dnf:
    name: epel-release
    state: present
    disable_gpg_check: false # Explicit GPG verification required
  become: true
  tags:
    - security
    - gpg_verification
    - adr_0001

- name: Verify EPEL repository is enabled
  ansible.builtin.command: dnf repolist enabled
  register: enabled_repos
  changed_when: false
  failed_when: "'epel' not in enabled_repos.stdout"
  tags:
    - verification
    - adr_0001

- name: Verify EPEL GPG key is properly imported
  ansible.builtin.command: rpm -q gpg-pubkey --qf '%{NAME}-%{VERSION}-%{RELEASE}\t%{SUMMARY}\n'
  register: epel_gpg_verification
  changed_when: false
  failed_when: false
  tags:
    - security
    - gpg_verification
    - adr_0001

- name: Update package cache (OS-aware)
  ansible.builtin.package:
    update_cache: true
  become: true
  when: ansible_facts['os_family'] == "RedHat"

- name: Update package cache for RHEL with GPG handling
  ansible.builtin.dnf:
    update_cache: true
    disable_gpg_check: false
  become: true
  when:
    - ansible_facts['os_family'] == "RedHat"
    - ansible_facts['distribution'] == "RedHat"

- name: Update package cache for Rocky/Alma Linux
  ansible.builtin.dnf:
    update_cache: true
    disable_gpg_check: false
  become: true
  when:
    - ansible_facts['os_family'] == "RedHat"
    - ansible_facts['distribution'] in ["Rocky", "AlmaLinux"]

- name: Install tigervnc-server and xrdp packages (RHEL 8/9 only)
  ansible.builtin.dnf:
    name:
      - tigervnc-server
      - xrdp
    state: present
  become: true
  when:
    - enable_vnc | default(true) | bool
    - kvmhost_os_major_version | int < 10
  tags:
    - remote_desktop
    - vnc
    - adr_0015

- name: Enable and start xrdp service
  ansible.builtin.systemd:
    name: xrdp
    enabled: true
    state: started
  become: true
  when:
    - enable_vnc | default(true) | bool
    - kvmhost_os_major_version | int < 10
  tags:
    - remote_desktop
    - vnc

- name: Configure firewall for RDP (port 3389)
  ansible.posix.firewalld:
    port: 3389/tcp
    permanent: true
    state: enabled
    immediate: true
  become: true
  when:
    - enable_vnc | default(true) | bool
    - kvmhost_os_major_version | int < 10
  tags:
    - remote_desktop
    - firewall

- name: Install RHEL/Fedora Web Console (Cockpit)
  ansible.builtin.include_role:
    name: linux-system-roles.cockpit
  vars:
    cockpit_packages: full

- name: Configure Firewall for Web Console
  ansible.posix.firewalld:
    port: 9090/tcp
    permanent: true
    state: enabled
    immediate: true
  become: true
