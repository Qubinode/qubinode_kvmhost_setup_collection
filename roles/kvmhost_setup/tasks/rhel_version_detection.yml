# RHEL version detection and conditional logic
# Based on ADR-0008: RHEL 9/10 Support Strategy

- name: Detect RHEL/CentOS/Rocky/AlmaLinux version and set facts
  tags:
    - rhel_detection
    - os_facts

  block:
    - name: Read OS release file for enhanced detection
      ansible.builtin.slurp:
        src: /etc/os-release
      register: os_release_content

    - name: Parse OS information from /etc/os-release
      ansible.builtin.set_fact:
        os_release_id: "{{ (os_release_content.content | b64decode | regex_search('ID=(.+)', '\\1'))[0] | regex_replace('\"', '') }}"
        os_release_version_id: "{{ (os_release_content.content | b64decode | regex_search('VERSION_ID=(.+)', '\\1'))[0] | regex_replace('\"', '') }}"
        os_release_name: "{{ (os_release_content.content | b64decode | regex_search('NAME=(.+)', '\\1'))[0] | regex_replace('\"', '') }}"

    - name: Set OS family facts with enhanced CentOS Stream 10 detection
      ansible.builtin.set_fact:
        kvmhost_os_family: >-
          {{
            'CentOS' if (os_release_id == 'centos' or 'CentOS Stream' in os_release_name) else
            ansible_distribution
          }}
        kvmhost_os_major_version: >-
          {{
            os_release_version_id if (os_release_id == 'centos' and ansible_distribution == 'Fedora') else
            ansible_distribution_major_version
          }}
        kvmhost_os_full_version: >-
          {{
            os_release_version_id if (os_release_id == 'centos' and ansible_distribution == 'Fedora') else
            ansible_distribution_version
          }}
        kvmhost_os_is_rhel_compatible: >-
          {{
            (os_release_id == 'centos') or
            (ansible_distribution in ['RedHat', 'CentOS', 'Rocky', 'AlmaLinux'])
          }}
        kvmhost_is_centos_stream: >-
          {{
            (os_release_id == 'centos' and 'Stream' in os_release_name) or
            (ansible_distribution == 'CentOS' and
             ('Stream' in ansible_distribution_version or 'stream' in ansible_distribution_version))
          }}

    - name: Set RHEL version-specific facts
      ansible.builtin.set_fact:
        kvmhost_is_rhel8: "{{ kvmhost_os_major_version == '8' and kvmhost_os_is_rhel_compatible }}"
        kvmhost_is_rhel9: "{{ kvmhost_os_major_version == '9' and kvmhost_os_is_rhel_compatible }}"
        kvmhost_is_rhel10: "{{ kvmhost_os_major_version == '10' and kvmhost_os_is_rhel_compatible }}"
        kvmhost_is_centos_stream10: "{{ kvmhost_os_major_version == '10' and kvmhost_is_centos_stream }}"

    - name: Set package manager facts based on OS version
      ansible.builtin.set_fact:
        kvmhost_package_manager: "{{ 'dnf' if kvmhost_os_major_version | int >= 8 else 'yum' }}"
        kvmhost_python_executable: "{{ 'python3' if kvmhost_os_major_version | int >= 8 else 'python' }}"
        kvmhost_pip_executable: "{{ 'pip3' if kvmhost_os_major_version | int >= 8 else 'pip' }}"

    - name: Display OS detection results
      ansible.builtin.debug:
        msg: |
          OS Detection Results:
          - Distribution: {{ kvmhost_os_family }} {{ kvmhost_os_full_version }}
          - Major Version: {{ kvmhost_os_major_version }}
          - RHEL Compatible: {{ kvmhost_os_is_rhel_compatible }}
          - CentOS Stream: {{ kvmhost_is_centos_stream }}
          - RHEL 8: {{ kvmhost_is_rhel8 }}
          - RHEL 9: {{ kvmhost_is_rhel9 }}
          - RHEL 10: {{ kvmhost_is_rhel10 }}
          - CentOS Stream 10: {{ kvmhost_is_centos_stream10 }}
          - Package Manager: {{ kvmhost_package_manager }}
          - Python: {{ kvmhost_python_executable }}

- name: Set version-specific package names
  ansible.builtin.set_fact:
    kvmhost_packages_base:
      rhel8:
        - libvirt
        - libvirt-daemon-kvm
        - qemu-kvm
        - virt-manager
        - virt-install
        - libguestfs-tools
        - iproute
        - NetworkManager
        - cockpit
        - cockpit-machines
        - python3-libvirt
        - python3-lxml
      rhel9:
        - libvirt
        - libvirt-daemon-kvm
        - qemu-kvm
        - virt-manager
        - virt-install
        - libguestfs-tools
        - iproute
        - NetworkManager
        - cockpit
        - cockpit-machines
        - python3-libvirt
        - python3-lxml
        - guestfs-tools
      rhel10:
        # RHEL 10 packages - Note: Some packages may not be available in UBI containers
        # This is expected behavior for container testing environments
        - libvirt
        - libvirt-daemon-kvm
        - qemu-kvm
        - virt-manager
        - virt-install
        - libguestfs-tools
        - iproute
        - NetworkManager
        - cockpit
        - cockpit-machines
        - python3-libvirt
        - python3-lxml
        - guestfs-tools
      rhel10_container_safe:
        # Minimal package set for RHEL 10 container testing
        # Only includes packages available in UBI repositories
        # Note: iproute is pre-installed in RHEL 10 UBI containers
        - python3-lxml  # Available in ubi-10-for-x86_64-appstream-rpms
        # NetworkManager-libnm is available but not the full NetworkManager package
      centos_stream10:
        # CentOS Stream 10 packages - optimized for next-gen platform
        - libvirt
        - libvirt-daemon-kvm
        - qemu-kvm
        - virt-manager
        - virt-install
        - libguestfs-tools
        - iproute
        - NetworkManager
        - cockpit
        - cockpit-machines
        - python3-libvirt
        - python3-lxml
        - guestfs-tools
        # CentOS Stream 10 specific packages
        - python3.12  # Explicit Python 3.12 support
        - podman      # Enhanced container support
  tags:
    - rhel_packages

- name: Set current OS package list
  ansible.builtin.set_fact:
    kvmhost_packages_current: >-
      {{
        kvmhost_packages_base.rhel10_container_safe if (
          kvmhost_is_rhel10 and is_container_environment | default(false)
        ) else
        kvmhost_packages_base.centos_stream10 if (kvmhost_is_centos_stream10 | default(false)) else
        kvmhost_packages_base.rhel10 if kvmhost_is_rhel10 else
        kvmhost_packages_base.rhel9 if kvmhost_is_rhel9 else
        kvmhost_packages_base.rhel8 if kvmhost_is_rhel8 else
        kvmhost_packages_base.rhel9
      }}
  tags:
    - rhel_packages

- name: Set version-specific service configurations
  ansible.builtin.set_fact:
    kvmhost_services:
      rhel8:
        - libvirtd
        - NetworkManager
        - cockpit.socket
      rhel9:
        - libvirtd
        - NetworkManager
        - cockpit.socket
      rhel10:
        - libvirtd
        - NetworkManager
        - cockpit.socket
      centos_stream10:
        - libvirtd
        - NetworkManager
        - cockpit.socket
        - podman.socket  # Enhanced container service support
  tags:
    - rhel_services

- name: Set current OS service list
  ansible.builtin.set_fact:
    kvmhost_services_current: >-
      {{ kvmhost_services.centos_stream10 if (kvmhost_is_centos_stream10 | default(false)) else
        kvmhost_services.rhel10 if kvmhost_is_rhel10 else
        kvmhost_services.rhel9 if kvmhost_is_rhel9 else
        kvmhost_services.rhel8 if kvmhost_is_rhel8 else
        kvmhost_services.rhel9 }}
  tags:
    - rhel_services

- name: Set version-specific firewall configurations
  ansible.builtin.set_fact:
    kvmhost_firewall_services:
      rhel8:
        - libvirt
        - cockpit
        - ssh
      rhel9:
        - libvirt
        - cockpit
        - ssh
      rhel10:
        - libvirt
        - cockpit
        - ssh
      centos_stream10:
        - libvirt
        - cockpit
        - ssh
  tags:
    - rhel_firewall

- name: Set current OS firewall service list
  ansible.builtin.set_fact:
    kvmhost_firewall_services_current: >-
      {{ kvmhost_firewall_services.centos_stream10 if (kvmhost_is_centos_stream10 | default(false)) else
        kvmhost_firewall_services.rhel10 if kvmhost_is_rhel10 else
        kvmhost_firewall_services.rhel9 if kvmhost_is_rhel9 else
        kvmhost_firewall_services.rhel8 if kvmhost_is_rhel8 else
        kvmhost_firewall_services.rhel9 }}
  tags:
    - rhel_firewall

- name: Set version-specific repository configurations
  ansible.builtin.set_fact:
    kvmhost_repos:
      rhel8:
        epel: epel-release
        codeready: codeready-builder-for-rhel-8-x86_64-rpms
      rhel9:
        epel: epel-release
        codeready: codeready-builder-for-rhel-9-x86_64-rpms
      rhel10:
        epel: epel-release
        codeready: codeready-builder-for-rhel-10-x86_64-rpms
      centos_stream10:
        epel: epel-release
        # CentOS Stream 10 uses CRB (CodeReady Builder) equivalent
        crb: crb
  tags:
    - rhel_repos

- name: Set current OS repository configuration
  ansible.builtin.set_fact:
    kvmhost_repos_current: >-
      {{ kvmhost_repos.centos_stream10 if (kvmhost_is_centos_stream10 | default(false)) else
        kvmhost_repos.rhel10 if kvmhost_is_rhel10 else
        kvmhost_repos.rhel9 if kvmhost_is_rhel9 else
        kvmhost_repos.rhel8 if kvmhost_is_rhel8 else
        kvmhost_repos.rhel9 }}
  tags:
    - rhel_repos

- name: Verify RHEL version compatibility
  ansible.builtin.assert:
    that:
      - kvmhost_os_is_rhel_compatible or kvmhost_is_centos_stream
      - kvmhost_os_major_version|int >= 8
    fail_msg: |
      Unsupported operating system: {{ kvmhost_os_family }} {{ kvmhost_os_full_version }}
      This role supports RHEL/CentOS/CentOS Stream/Rocky/AlmaLinux versions 8, 9, and 10 only.
    success_msg: |
      OS compatibility confirmed: {{ kvmhost_os_family }} {{ kvmhost_os_full_version }} is supported.
      {{
        'CentOS Stream 10 detected - next-generation platform support enabled!'
        if kvmhost_is_centos_stream10 else ''
      }}
  tags:
    - rhel_validation
