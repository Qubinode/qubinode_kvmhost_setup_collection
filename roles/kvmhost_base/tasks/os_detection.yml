# OS Detection and Version Facts
# Based on ADR-0008: RHEL 9/10 Support Strategy

- name: Read OS release file for enhanced detection
  ansible.builtin.slurp:
    src: /etc/os-release
  register: os_release_content

- name: Parse OS information from /etc/os-release
  ansible.builtin.set_fact:
    os_release_id: >-
      {{ (os_release_content.content | b64decode | 
         regex_search('ID=(.+)', '\\1'))[0] | regex_replace('\"', '') }}
    os_release_version_id: >-
      {{ (os_release_content.content | b64decode | 
         regex_search('VERSION_ID=(.+)', '\\1'))[0] | regex_replace('\"', '') }}
    os_release_name: >-
      {{ (os_release_content.content | b64decode | 
         regex_search('NAME=(.+)', '\\1'))[0] | regex_replace('\"', '') }}

- name: Detect OS family and version with enhanced CentOS Stream 10 detection
  ansible.builtin.set_fact:
    kvmhost_os_family: >-
      {{
        'CentOS' if (os_release_id == 'centos' or 'CentOS Stream' in os_release_name) else
        ansible_distribution
      }}
    kvmhost_os_major_version: >-
      {{
        os_release_version_id if (os_release_id == 'centos' and ansible_distribution == 'Fedora') else
        ansible_distribution_major_version
      }}
    kvmhost_os_full_version: >-
      {{
        os_release_version_id if (os_release_id == 'centos' and ansible_distribution == 'Fedora') else
        ansible_distribution_version
      }}
    kvmhost_os_is_rhel_compatible: >-
      {{
        (os_release_id == 'centos') or
        (ansible_distribution in supported_os_families)
      }}
    kvmhost_is_centos_stream: >-
      {{
        (os_release_id == 'centos' and 'Stream' in os_release_name) or
        (ansible_distribution == 'CentOS' and
         ('Stream' in ansible_distribution_version or 'stream' in ansible_distribution_version))
      }}

- name: Set RHEL version-specific facts
  ansible.builtin.set_fact:
    kvmhost_is_rhel8: "{{ kvmhost_os_major_version == '8' and kvmhost_os_is_rhel_compatible }}"
    kvmhost_is_rhel9: "{{ kvmhost_os_major_version == '9' and kvmhost_os_is_rhel_compatible }}"
    kvmhost_is_rhel10: "{{ kvmhost_os_major_version == '10' and kvmhost_os_is_rhel_compatible }}"
    kvmhost_is_centos_stream10: "{{ kvmhost_os_major_version == '10' and kvmhost_is_centos_stream }}"

- name: Set package manager facts based on OS version
  ansible.builtin.set_fact:
    kvmhost_package_manager: "{{ 'dnf' if kvmhost_os_major_version | int >= 8 else 'yum' }}"
    kvmhost_python_executable: "{{ 'python3' if kvmhost_os_major_version | int >= 8 else 'python' }}"
    kvmhost_pip_executable: "{{ 'pip3' if kvmhost_os_major_version | int >= 8 else 'pip' }}"

- name: Set architecture facts
  ansible.builtin.set_fact:
    kvmhost_architecture: "{{ ansible_architecture }}"
    kvmhost_is_x86_64: "{{ ansible_architecture == 'x86_64' }}"

- name: Display OS detection results
  ansible.builtin.debug:
    msg: |
      OS Detection Results:
      - Distribution: {{ kvmhost_os_family }} {{ kvmhost_os_full_version }}
      - Major Version: {{ kvmhost_os_major_version }}
      - RHEL Compatible: {{ kvmhost_os_is_rhel_compatible }}
      - RHEL 8: {{ kvmhost_is_rhel8 }}
      - RHEL 9: {{ kvmhost_is_rhel9 }}
      - RHEL 10: {{ kvmhost_is_rhel10 }}
      - Package Manager: {{ kvmhost_package_manager }}
      - Python: {{ kvmhost_python_executable }}
      - Architecture: {{ kvmhost_architecture }}
  tags:
    - debug
